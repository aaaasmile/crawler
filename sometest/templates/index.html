{{define "base"}}
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="./static/lib/d3.v7.js?{{.Buildnr}}"></script>
    <title>SVG converter</title>
</head>

<body>
    <p id="title">Here will be changed</p>
    <div id="container"></div>
    <button type="button" onclick="myfun()">Try It</button>
</body>
<script>
    function myfun() {
        console.log('my fun is called')
        d3.select("p").style("color", "green");
        document.getElementById("title").innerHTML = "Title changed by javascript";
    }
</script>

<script type="module">
    // Declare the chart dimensions and margins.
    const width = 640;
    const height = 400;
    const marginTop = 20;
    const marginRight = 20;
    const marginBottom = 30;
    const marginLeft = 40;

    // Declare the x (horizontal position) scale.
    const x = d3.scaleUtc()
        .domain([new Date("2023-01-01"), new Date("2024-01-01")])
        .range([marginLeft, width - marginRight]);

    // Declare the y (vertical position) scale.
    const y = d3.scaleLinear()
        .domain([0, 100])
        .range([height - marginBottom, marginTop]);

    // Create the SVG container.
    const svg = d3.create("svg")
        .attr("width", width)
        .attr("height", height);

    // Add the x-axis.
    svg.append("g")
        .attr("transform", `translate(0,${height - marginBottom})`)
        .call(d3.axisBottom(x));

    // Add the y-axis.
    svg.append("g")
        .attr("transform", `translate(${marginLeft},0)`)
        .call(d3.axisLeft(y));

    // Append the SVG element.
    container.append(svg.node());

</script>

<script type="module">
    let styleRules = [];
    var requiredSheets = []; // list of required CSS files
    for (let i = 0; i < document.styleSheets.length; i++) {
        const sheet = document.styleSheets[i];
        if (sheet.href) {
            const sheetName = sheet.href.split('/').pop();
            if (requiredSheets.indexOf(sheetName) != -1) {
                const rules = Array.from(sheet.cssRules).map(rule => rule.cssText);
                styleRules = styleRules.concat(rules);
            }
        }
    }
    //var styleText = styleRules.join(' ');
    var styleNode = document.createCDATASection(styleRules);

    var svgcanv = d3.select("svg");
    var img = new Image();
    const serializer = new XMLSerializer();
    svgcanv.insert('defs', ":first-child");
    let styleEl = d3.select("svg defs")
        .append('style')
        .attr('type', 'text/css');

    styleEl.node().appendChild(styleNode);

    var svgStr = serializer.serializeToString(svgcanv.node());
    img.src = 'data:image/svg+xml;base64,' + window.btoa(unescape(encodeURIComponent(svgStr)));

    const bbox = svgcanv.getBoundingClientRect();

    let canvas = document.createElement("canvas");

    canvas.width = bbox.width;
    canvas.height = bbox.height;
    canvas.getContext("2d").drawImage(img, 0, 0, bbox.width, bbox.width);

    canvas.parentNode.replaceChild(canvas, svgcanv);
</script>

</html>

{{end}}
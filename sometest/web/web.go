package web

import (
	"encoding/base64"
	"fmt"
	"log"
	"net/http"
	"net/url"
	"strings"
	"text/template"
	"time"
)

type PageCtx struct {
	Buildnr     string
	SvgData     string
	SvgDataBa64 string
}

const (
	buildnr = "00.00.10.00"
)

func handleGet(w http.ResponseWriter, req *http.Request) error {
	var err error
	u, _ := url.Parse(req.RequestURI)
	log.Println("GET requested ", u)

	svgstr := `<svg version="1.1" class="highcharts-root" xmlns="http://www.w3.org/2000/svg" width="408" height="200" viewBox="0 0 408 200"><desc>Created with Highcharts 7.0.1</desc><defs><style>.highcharts-3d-top{filter: url(#highcharts-brighter)}
	.highcharts-3d-side{filter: url(#highcharts-darker)}
	</style><filter id="highcharts-darker"><feComponentTransfer><feFuncR type="linear" slope="0.6"></feFuncR><feFuncG type="linear" slope="0.6"></feFuncG><feFuncB type="linear" slope="0.6"></feFuncB></feComponentTransfer></filter><filter id="highcharts-brighter"><feComponentTransfer><feFuncR type="linear" slope="1.4"></feFuncR><feFuncG type="linear" slope="1.4"></feFuncG><feFuncB type="linear" slope="1.4"></feFuncB></feComponentTransfer></filter><clipPath id="highcharts-nakxugb-1"><rect x="0" y="0" width="349" height="167"></rect></clipPath><clipPath id="highcharts-nakxugb-32"><rect x="-96.48025917701958" y="-5" width="107.8827226991936" height="200"></rect></clipPath><clipPath id="highcharts-nakxugb-33"><rect x="0" y="0" width="8.882722699193593" height="167"></rect></clipPath><clipPath id="highcharts-nakxugb-34"><rect x="0" y="103" width="408" height="69"></rect></clipPath><clipPath id="highcharts-nakxugb-35"><rect x="0" y="0" width="408" height="103"></rect></clipPath></defs><rect class="highcharts-background" x="0.5" y="0.5" width="406" height="198" rx="0" ry="0"></rect><rect class="highcharts-plot-background" x="1" y="5" width="349" height="167"></rect><g class="highcharts-pane-group" data-z-index="0"></g><g class="highcharts-plot-lines-0" data-z-index="0"><path class="highcharts-plot-line " d="M 1 108 L 350 108"></path></g><g class="highcharts-grid highcharts-xaxis-grid highcharts-nogrid" data-z-index="1"><path data-z-index="1" class="highcharts-grid-line" d="M 23.5 5 L 23.5 172" opacity="1"></path><path data-z-index="1" class="highcharts-grid-line" d="M 116.5 5 L 116.5 172" opacity="1"></path><path data-z-index="1" class="highcharts-grid-line" d="M 209.5 5 L 209.5 172" opacity="1"></path><path data-z-index="1" class="highcharts-grid-line" d="M 302.5 5 L 302.5 172" opacity="1"></path></g><g class="highcharts-grid highcharts-yaxis-grid highcharts-nogrid" data-z-index="1"><path data-z-index="1" class="highcharts-grid-line" d="M 1 135.5 L 350 135.5" opacity="1"></path><path data-z-index="1" class="highcharts-grid-line" d="M 1 96.5 L 350 96.5" opacity="1"></path><path data-z-index="1" class="highcharts-grid-line" d="M 1 56.5 L 350 56.5" opacity="1"></path><path data-z-index="1" class="highcharts-grid-line" d="M 1 16.5 L 350 16.5" opacity="1"></path></g><rect class="highcharts-plot-border" data-z-index="1" x="0.5" y="4.5" width="350" height="168"></rect><g class="highcharts-axis highcharts-xaxis highcharts-nogrid" data-z-index="2"><path class="highcharts-axis-line" d="M 1 172 L 350 172"></path><path class="highcharts-tick" d="M 24 172 L 24 182" opacity="1"></path><path class="highcharts-tick" d="M 117 172 L 117 182" opacity="1"></path><path class="highcharts-tick" d="M 210 172 L 210 182" opacity="1"></path><path class="highcharts-tick" d="M 303 172 L 303 182" opacity="1"></path></g><g class="highcharts-axis highcharts-yaxis highcharts-nogrid" data-z-index="2"><path class="highcharts-axis-line" d="M 350 5 L 350 172"></path></g><g class="highcharts-series-group" data-z-index="3"><g data-z-index="0.1" class="highcharts-series highcharts-series-0 highcharts-area-series highcharts-color-0 highcharts-positive" transform="translate(1,5) scale(1 1)" clip-path="url(#highcharts-nakxugb-33)"><path d="M 0 103.38095238095346 L 23.266666666667 103.38095238095346 L 25.205555555556 65.20952380952468 L 31.022222222222 85.8857142857151 L 38.777777777778 36.580952380952056 L 42.655555555556 68.39047619047673 L 58.166666666667 36.580952380952056 L 60.105555555556 54.07619047619042 L 65.922222222222 46.1238095238096 L 71.738888888889 44.533333333334284 L 93.066666666667 47.71428571428632 L 98.883333333333 36.580952380952056 L 100.82222222222 39.76190476190551 L 116.33333333333 23.857142857142463 L 118.27222222222 31.809523809524677 L 139.6 36.580952380952056 L 149.29444444444 54.07619047619042 L 155.11111111111 65.20952380952468 L 166.74444444444 97.01904761904795 L 170.62222222222 98.60952380952469 L 172.56111111111 89.06666666666715 L 199.70555555556 114.51428571428633 L 203.58333333333 106.56190476190551 L 222.97222222222 74.75238095238082 L 246.23888888889 101.79047619047672 L 261.75 106.56190476190551 L 327.67222222222 106.56190476190551 L 337.36666666667 143.14285714285754 L 347.06111111111 104.97142857142877 L 349 104.97142857142877 L 349 103.38095238095346 L 347.06111111111 103.38095238095346 L 337.36666666667 103.38095238095346 L 327.67222222222 103.38095238095346 L 261.75 103.38095238095346 L 246.23888888889 103.38095238095346 L 222.97222222222 103.38095238095346 L 203.58333333333 103.38095238095346 L 199.70555555556 103.38095238095346 L 172.56111111111 103.38095238095346 L 170.62222222222 103.38095238095346 L 166.74444444444 103.38095238095346 L 155.11111111111 103.38095238095346 L 149.29444444444 103.38095238095346 L 139.6 103.38095238095346 L 118.27222222222 103.38095238095346 L 116.33333333333 103.38095238095346 L 100.82222222222 103.38095238095346 L 98.883333333333 103.38095238095346 L 93.066666666667 103.38095238095346 L 71.738888888889 103.38095238095346 L 65.922222222222 103.38095238095346 L 60.105555555556 103.38095238095346 L 58.166666666667 103.38095238095346 L 42.655555555556 103.38095238095346 L 38.777777777778 103.38095238095346 L 31.022222222222 103.38095238095346 L 25.205555555556 103.38095238095346 L 23.266666666667 103.38095238095346 L 0 103.38095238095346" class="highcharts-area" data-z-index="0" visibility="hidden"></path><path d="M 0 103.38095238095346 L 23.266666666667 103.38095238095346 L 25.205555555556 65.20952380952468 L 31.022222222222 85.8857142857151 L 38.777777777778 36.580952380952056 L 42.655555555556 68.39047619047673 L 58.166666666667 36.580952380952056 L 60.105555555556 54.07619047619042 L 65.922222222222 46.1238095238096 L 71.738888888889 44.533333333334284 L 93.066666666667 47.71428571428632 L 98.883333333333 36.580952380952056 L 100.82222222222 39.76190476190551 L 116.33333333333 23.857142857142463 L 118.27222222222 31.809523809524677 L 139.6 36.580952380952056 L 149.29444444444 54.07619047619042 L 155.11111111111 65.20952380952468 L 166.74444444444 97.01904761904795 L 170.62222222222 98.60952380952469 L 172.56111111111 89.06666666666715 L 199.70555555556 114.51428571428633 L 203.58333333333 106.56190476190551 L 222.97222222222 74.75238095238082 L 246.23888888889 101.79047619047672 L 261.75 106.56190476190551 L 327.67222222222 106.56190476190551 L 337.36666666667 143.14285714285754 L 347.06111111111 104.97142857142877 L 349 104.97142857142877 L 349 103.38095238095346 L 347.06111111111 103.38095238095346 L 337.36666666667 103.38095238095346 L 327.67222222222 103.38095238095346 L 261.75 103.38095238095346 L 246.23888888889 103.38095238095346 L 222.97222222222 103.38095238095346 L 203.58333333333 103.38095238095346 L 199.70555555556 103.38095238095346 L 172.56111111111 103.38095238095346 L 170.62222222222 103.38095238095346 L 166.74444444444 103.38095238095346 L 155.11111111111 103.38095238095346 L 149.29444444444 103.38095238095346 L 139.6 103.38095238095346 L 118.27222222222 103.38095238095346 L 116.33333333333 103.38095238095346 L 100.82222222222 103.38095238095346 L 98.883333333333 103.38095238095346 L 93.066666666667 103.38095238095346 L 71.738888888889 103.38095238095346 L 65.922222222222 103.38095238095346 L 60.105555555556 103.38095238095346 L 58.166666666667 103.38095238095346 L 42.655555555556 103.38095238095346 L 38.777777777778 103.38095238095346 L 31.022222222222 103.38095238095346 L 25.205555555556 103.38095238095346 L 23.266666666667 103.38095238095346 L 0 103.38095238095346" class="highcharts-area highcharts-zone-area-0 highcharts-negative" data-z-index="0" clip-path="url(#highcharts-nakxugb-34)"></path><path d="M 0 103.38095238095346 L 23.266666666667 103.38095238095346 L 25.205555555556 65.20952380952468 L 31.022222222222 85.8857142857151 L 38.777777777778 36.580952380952056 L 42.655555555556 68.39047619047673 L 58.166666666667 36.580952380952056 L 60.105555555556 54.07619047619042 L 65.922222222222 46.1238095238096 L 71.738888888889 44.533333333334284 L 93.066666666667 47.71428571428632 L 98.883333333333 36.580952380952056 L 100.82222222222 39.76190476190551 L 116.33333333333 23.857142857142463 L 118.27222222222 31.809523809524677 L 139.6 36.580952380952056 L 149.29444444444 54.07619047619042 L 155.11111111111 65.20952380952468 L 166.74444444444 97.01904761904795 L 170.62222222222 98.60952380952469 L 172.56111111111 89.06666666666715 L 199.70555555556 114.51428571428633 L 203.58333333333 106.56190476190551 L 222.97222222222 74.75238095238082 L 246.23888888889 101.79047619047672 L 261.75 106.56190476190551 L 327.67222222222 106.56190476190551 L 337.36666666667 143.14285714285754 L 347.06111111111 104.97142857142877 L 349 104.97142857142877 L 349 103.38095238095346 L 347.06111111111 103.38095238095346 L 337.36666666667 103.38095238095346 L 327.67222222222 103.38095238095346 L 261.75 103.38095238095346 L 246.23888888889 103.38095238095346 L 222.97222222222 103.38095238095346 L 203.58333333333 103.38095238095346 L 199.70555555556 103.38095238095346 L 172.56111111111 103.38095238095346 L 170.62222222222 103.38095238095346 L 166.74444444444 103.38095238095346 L 155.11111111111 103.38095238095346 L 149.29444444444 103.38095238095346 L 139.6 103.38095238095346 L 118.27222222222 103.38095238095346 L 116.33333333333 103.38095238095346 L 100.82222222222 103.38095238095346 L 98.883333333333 103.38095238095346 L 93.066666666667 103.38095238095346 L 71.738888888889 103.38095238095346 L 65.922222222222 103.38095238095346 L 60.105555555556 103.38095238095346 L 58.166666666667 103.38095238095346 L 42.655555555556 103.38095238095346 L 38.777777777778 103.38095238095346 L 31.022222222222 103.38095238095346 L 25.205555555556 103.38095238095346 L 23.266666666667 103.38095238095346 L 0 103.38095238095346" class="highcharts-area highcharts-zone-area-1 undefined" data-z-index="0" clip-path="url(#highcharts-nakxugb-35)"></path><path d="M 0 103.38095238095346 L 23.266666666667 103.38095238095346 L 25.205555555556 65.20952380952468 L 31.022222222222 85.8857142857151 L 38.777777777778 36.580952380952056 L 42.655555555556 68.39047619047673 L 58.166666666667 36.580952380952056 L 60.105555555556 54.07619047619042 L 65.922222222222 46.1238095238096 L 71.738888888889 44.533333333334284 L 93.066666666667 47.71428571428632 L 98.883333333333 36.580952380952056 L 100.82222222222 39.76190476190551 L 116.33333333333 23.857142857142463 L 118.27222222222 31.809523809524677 L 139.6 36.580952380952056 L 149.29444444444 54.07619047619042 L 155.11111111111 65.20952380952468 L 166.74444444444 97.01904761904795 L 170.62222222222 98.60952380952469 L 172.56111111111 89.06666666666715 L 199.70555555556 114.51428571428633 L 203.58333333333 106.56190476190551 L 222.97222222222 74.75238095238082 L 246.23888888889 101.79047619047672 L 261.75 106.56190476190551 L 327.67222222222 106.56190476190551 L 337.36666666667 143.14285714285754 L 347.06111111111 104.97142857142877 L 349 104.97142857142877" class="highcharts-graph" data-z-index="1" visibility="hidden"></path><path d="M 0 103.38095238095346 L 23.266666666667 103.38095238095346 L 25.205555555556 65.20952380952468 L 31.022222222222 85.8857142857151 L 38.777777777778 36.580952380952056 L 42.655555555556 68.39047619047673 L 58.166666666667 36.580952380952056 L 60.105555555556 54.07619047619042 L 65.922222222222 46.1238095238096 L 71.738888888889 44.533333333334284 L 93.066666666667 47.71428571428632 L 98.883333333333 36.580952380952056 L 100.82222222222 39.76190476190551 L 116.33333333333 23.857142857142463 L 118.27222222222 31.809523809524677 L 139.6 36.580952380952056 L 149.29444444444 54.07619047619042 L 155.11111111111 65.20952380952468 L 166.74444444444 97.01904761904795 L 170.62222222222 98.60952380952469 L 172.56111111111 89.06666666666715 L 199.70555555556 114.51428571428633 L 203.58333333333 106.56190476190551 L 222.97222222222 74.75238095238082 L 246.23888888889 101.79047619047672 L 261.75 106.56190476190551 L 327.67222222222 106.56190476190551 L 337.36666666667 143.14285714285754 L 347.06111111111 104.97142857142877 L 349 104.97142857142877" class="highcharts-graph highcharts-zone-graph-0 highcharts-negative" data-z-index="1" clip-path="url(#highcharts-nakxugb-34)"></path><path d="M 0 103.38095238095346 L 23.266666666667 103.38095238095346 L 25.205555555556 65.20952380952468 L 31.022222222222 85.8857142857151 L 38.777777777778 36.580952380952056 L 42.655555555556 68.39047619047673 L 58.166666666667 36.580952380952056 L 60.105555555556 54.07619047619042 L 65.922222222222 46.1238095238096 L 71.738888888889 44.533333333334284 L 93.066666666667 47.71428571428632 L 98.883333333333 36.580952380952056 L 100.82222222222 39.76190476190551 L 116.33333333333 23.857142857142463 L 118.27222222222 31.809523809524677 L 139.6 36.580952380952056 L 149.29444444444 54.07619047619042 L 155.11111111111 65.20952380952468 L 166.74444444444 97.01904761904795 L 170.62222222222 98.60952380952469 L 172.56111111111 89.06666666666715 L 199.70555555556 114.51428571428633 L 203.58333333333 106.56190476190551 L 222.97222222222 74.75238095238082 L 246.23888888889 101.79047619047672 L 261.75 106.56190476190551 L 327.67222222222 106.56190476190551 L 337.36666666667 143.14285714285754 L 347.06111111111 104.97142857142877 L 349 104.97142857142877" class="highcharts-graph highcharts-zone-graph-1 " data-z-index="1" clip-path="url(#highcharts-nakxugb-35)"></path><path d="M -10 103.38095238095346 L 0 103.38095238095346 L 23.266666666667 103.38095238095346 L 25.205555555556 65.20952380952468 L 31.022222222222 85.8857142857151 L 38.777777777778 36.580952380952056 L 42.655555555556 68.39047619047673 L 58.166666666667 36.580952380952056 L 60.105555555556 54.07619047619042 L 65.922222222222 46.1238095238096 L 71.738888888889 44.533333333334284 L 93.066666666667 47.71428571428632 L 98.883333333333 36.580952380952056 L 100.82222222222 39.76190476190551 L 116.33333333333 23.857142857142463 L 118.27222222222 31.809523809524677 L 139.6 36.580952380952056 L 149.29444444444 54.07619047619042 L 155.11111111111 65.20952380952468 L 166.74444444444 97.01904761904795 L 170.62222222222 98.60952380952469 L 172.56111111111 89.06666666666715 L 199.70555555556 114.51428571428633 L 203.58333333333 106.56190476190551 L 222.97222222222 74.75238095238082 L 246.23888888889 101.79047619047672 L 261.75 106.56190476190551 L 327.67222222222 106.56190476190551 L 337.36666666667 143.14285714285754 L 347.06111111111 104.97142857142877 L 349 104.97142857142877 L 359 104.97142857142877" visibility="visible" data-z-index="2" class="highcharts-tracker-line"></path></g><g data-z-index="0.1" class="highcharts-markers highcharts-series-0 highcharts-area-series highcharts-color-0 highcharts-positive highcharts-tracker" transform="translate(1,5) scale(1 1)" clip-path="url(#highcharts-nakxugb-32)"></g></g><text x="204" text-anchor="middle" class="highcharts-title" data-z-index="4" y="27"></text><text x="204" text-anchor="middle" class="highcharts-subtitle" data-z-index="4" y="26"></text><g class="highcharts-axis-labels highcharts-xaxis-labels highcharts-nogrid" data-z-index="7"><text x="24.266666666667" text-anchor="middle" transform="translate(0,0)" y="193" opacity="1">08:00</text><text x="117.33333333333" text-anchor="middle" transform="translate(0,0)" y="193" opacity="1">12:00</text><text x="210.4" text-anchor="middle" transform="translate(0,0)" y="193" opacity="1">16:00</text><text x="303.46666666667" text-anchor="middle" transform="translate(0,0)" y="193" opacity="1">20:00</text></g><g class="highcharts-axis-labels highcharts-yaxis-labels highcharts-nogrid" data-z-index="7"><text x="397.7049865722656" text-anchor="end" transform="translate(0,0)" y="140" opacity="1"><tspan>15,40</tspan></text><text x="397.7049865722656" text-anchor="end" transform="translate(0,0)" y="100" opacity="1"><tspan>15,45</tspan></text><text x="397.7049865722656" text-anchor="end" transform="translate(0,0)" y="60" opacity="1"><tspan>15,50</tspan></text><text x="397.7049865722656" text-anchor="end" transform="translate(0,0)" y="21" opacity="1"><tspan>15,55</tspan></text></g></svg>`
	svgstr = strings.ReplaceAll(svgstr, "\n", "")
	svgstr = strings.ReplaceAll(svgstr, "\r", "")
	svgstrtoba := base64.StdEncoding.EncodeToString([]byte(svgstr))
	svgstrtoba = fmt.Sprintf("data:image/svg+xml;base64, %s", svgstrtoba)
	pagectx := PageCtx{
		Buildnr:     buildnr,
		SvgData:     svgstr,
		SvgDataBa64: svgstrtoba,
	}

	templName := "templates/index.html"

	tmplIndex := template.Must(template.New("AppIndex").ParseFiles(templName))

	err = tmplIndex.ExecuteTemplate(w, "base", pagectx)
	if err != nil {
		return err
	}

	return nil
}

func apiHandler(w http.ResponseWriter, req *http.Request) {
	switch req.Method {
	case "GET":
		if err := handleGet(w, req); err != nil {
			log.Println("Error on process request: ", err)
			http.Error(w, "Internal Server Error", http.StatusInternalServerError)
		}
	}
}

func StartServer() {
	//scrap.Scrap()
	serverurl := "127.0.0.1:5903"
	rootURLPattern := "/svg/"
	finalServURL := fmt.Sprintf("http://%s%s", strings.Replace(serverurl, "0.0.0.0", "localhost", 1), rootURLPattern)

	finalServURL = strings.Replace(finalServURL, "127.0.0.1", "localhost", 1)
	log.Println("Server started with URL ", serverurl)
	log.Println("Try this url: ", finalServURL)

	http.Handle(rootURLPattern+"static/", http.StripPrefix(rootURLPattern+"static", http.FileServer(http.Dir("static"))))
	http.HandleFunc(rootURLPattern, apiHandler)

	srv := &http.Server{
		Addr:         serverurl,
		WriteTimeout: time.Second * 15,
		ReadTimeout:  time.Second * 15,
		IdleTimeout:  time.Second * 60,
		Handler:      nil,
	}
	if err := srv.ListenAndServe(); err != nil {
		log.Println("Server is not listening anymore: ", err)
	}
}
